<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sketchpad</title>
    <style>@charset "UTF-8";:root{--live-preview-extension-background:white;--live-preview-extension-inactive:rgb(199, 69, 69);--live-preview-extension-active:rgb(0, 119, 166);--live-preview-extension-light:white;--live-preview-extension-dark:rgb(70, 70, 70);--live-preview-extension-delta:1.2rem;--live-preview-font-family:monospace;}.\~frag\$\$widget{gap:.8rem !important;display:flex !important;box-sizing:border-box !important;flex-direction:column !important;justify-content:flex-start !important;color:var(--live-preview-extension-dark) !important;background-color:var(--live-preview-extension-light) !important;box-shadow:rgba(14, 30, 37, 0.12) 0px 2px 4px 0px, rgba(14, 30, 37, 0.32) 0px 2px 16px 0px !important;position:fixed !important;padding:.8rem !important;border-radius:1rem !important;opacity:.64 !important;transition:opacity 0.2s ease !important;}.\~frag\$\$widget:hover{opacity:.9 !important;}.\~frag\$\$widget *{outline:none !important;line-height:1.2em !important;box-sizing:inherit !important;}.\~frag\$\$widget *:hover{outline:none !important;}</style>
</head>

<body id="live-preview-body" class="~$body" >

    <div id="live-preview-widget" style="top: 16px; left:16px; z-index: 1000000 !important;" class="~frag$$widget">
        
	<div class="~$options" >

		<label id="live-preview-option-drag-handle" title="Move Widget">
			<svg>
				<use href="#\#move"></use>
			</svg> </label>
		<label for="live-preview-option-color-picker" title="Background Color">
			<svg>
				<use href="#\#bgcolor"></use>
			</svg>
			<input id="live-preview-option-color-picker" type="color">
		</label>

		<div style="width: var(--live-preview-extension-delta);"></div>

		<label for="live-preview-option-stop-sync" title="Deactivate Sync">
			<svg>
				<use href="#\#unsync"></use>
			</svg>
			<input id="live-preview-option-stop-sync" type="checkbox">
		</label>

		<label for="live-preview-option-live-cursor" title="Live Cursor">
			<svg>
				<use href="#\#cursor"></use>
			</svg>
			<input id="live-preview-option-live-cursor" type="checkbox">
		</label>

		<label for="live-preview-option-project-index" title="Project Theme">
			<svg>
				<use href="#\#theme"></use>
			</svg>
			<input id="live-preview-option-project-index" type="checkbox">
		</label>

		<label for="live-preview-option-container-resize" title="Rescale Handle">
			<svg>
				<use href="#\#rescale"></use>
			</svg>
			<input id="live-preview-option-container-resize" type="checkbox">
		</label>

		<label for="live-preview-option-preserve-scale" title="Preserve Scale">
			<svg>
				<use href="#\#preserve"></use>
			</svg>
			<input id="live-preview-option-preserve-scale" type="checkbox">
		</label>

		<label for="live-preview-option-debug-mode" title="Debug Mode">
			<svg>
				<use href="#\#debug"></use>
			</svg>
			<input id="live-preview-option-debug-mode" type="checkbox">
		</label>

	</div>
	<div id="live-preview-symlink" class="~$symlink" >N/A</div>

    </div>

    <div id="live-preview-output-stitch" style="display: none;"></div>

    <style id="live-preview-root-css"></style>
    <style id="live-preview-comp-css"></style>
    <main id="live-preview-main" class="~$op" >

        <div id="live-preview-output-container" data-live-preview-output-container-resize="true"
            data-live-preview-output-container-preserve="true" data-live-preview-output-container-debug="true">
            <div>{Content}</div>
        </div>
    </main>

    <div style="display: none;">
        
    </div>

    
    <script>

        const AUTOREFRESH = false;

        // --- Initial Load ---

        const RootBody = document.getElementById('live-preview-body');
        const RootMain = document.getElementById('live-preview-main');
        window.addEventListener('load', () => {
            setTimeout(() => {
                RootBody.parentElement.removeAttribute("style");
            }, 100);
        });

        // --- Deploy Output Fragment ----

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        const StitchElement = document.getElementById('live-preview-output-stitch');
        const OutputElement = document.getElementById('live-preview-output-container');
        const RootCssElement = document.getElementById('live-preview-root-css');
        const CompCssElement = document.getElementById('live-preview-comp-css');
        const SymlinkElement = document.getElementById('live-preview-symlink');

        const activeComponent = {
            preview: "",
            element: "",
            depends: "",
            symlink: "",
            rootcss: "",
            compcss: "",
            configs: {},
            attributes: {},
            timestamp: ""
        };

        const outputState = {
            useProjectCss: false,
            activateResize: false,
            preserveScale: false,
            activateDebug: false,
            syncDeactivate: false,
        };


        let OutputStyle = '';
        function OutputUpdate(
            updateComponent = false,
            newComponent = activeComponent,
            syncForce = !outputState.syncDeactivate
        ) {

            if (OutputElement.hasAttribute('style')) { OutputStyle = OutputElement.getAttribute('style') ?? OutputStyle; }

            if (outputState.preserveScale) {
                OutputElement.setAttribute('style', OutputStyle);
            } else {
                if (outputState.activateResize && !OutputElement.hasAttribute('style')) { OutputElement.setAttribute('style', OutputStyle); }
                else if (!outputState.activateResize && OutputElement.hasAttribute('style')) { OutputElement.removeAttribute('style'); }
            }
            OutputElement.setAttribute("data-live-preview-output-container-debug", String(outputState.activateDebug))
            OutputElement.setAttribute("data-live-preview-output-container-resize", String(outputState.activateResize))
            OutputElement.setAttribute("data-live-preview-output-container-preserve", String(outputState.preserveScale))

            if (updateComponent && syncForce) {
                CompCssElement.innerText = newComponent.compcss;
                RootCssElement.innerText = outputState.useProjectCss ? newComponent.rootcss : "";

                const stitch = (typeof newComponent.depends === "string") ? newComponent.depends : '';
                const structure = (typeof newComponent.preview === "string" && newComponent.preview.length) ? newComponent.preview : "[Placeholder]";
                const selector = (typeof newComponent.symlink === "string" && newComponent.symlink.length) ? newComponent.symlink : '[N/A]';

                StitchElement.innerHTML = stitch;
                OutputElement.innerHTML = structure;
                OutputElement.className = "_";
                SymlinkElement.innerHTML = selector;
                const attributes = newComponent.attributes || {};

                RootMain.setAttribute(
                    "style",
                    typeof attributes["style"] === "string"
                        ? attributes["style"].replace(/^['"]|['"]$/g, "")
                        : ""
                );

                const attrTrace = {};
                const constAttrs = [
                    "id", "style",
                    "data-live-preview-output-container-debug",
                    "data-live-preview-output-container-resize",
                    "data-live-preview-output-container-preserve"
                ]
                OutputElement.getAttributeNames().forEach(a => {
                    if (!constAttrs.includes(a) && a !== "class") { attrTrace[a] = true; }
                });

                Object.keys(attributes).forEach(a => {
                    if (!constAttrs.includes(a)) { attrTrace[a] = false; }
                });

                Object.entries(attrTrace).forEach(([attr, delflag]) => {
                    if (delflag) {
                        OutputElement.removeAttribute(attr)
                    } else if (attr === "class") {
                        const fval = attributes[attr].replace(/^['"]|['"]$/g, "")
                        OutputElement.classList.add(...fval.split(" "))
                    } else {
                        const fval = attributes[attr].replace(/^['"]|['"]$/g, "")
                        OutputElement.setAttribute(attr, fval)
                    }
                })
            }
            Object.assign(activeComponent, newComponent);
        }

        // --- Drag handle Logic ---

        let dragActive = false;
        const dragStart = { x: 0, y: 0 };
        const dragPosition = { top: 0, left: 0 };
        const widgetElement = document.getElementById('live-preview-widget');
        const dragElement = document.getElementById('live-preview-option-drag-handle');

        if (dragElement && widgetElement) {
            dragElement.addEventListener('mousedown', (e) => {
                dragActive = true;
                dragStart.x = e.clientX;
                dragStart.y = e.clientY;
                const computedStyle = window.getComputedStyle(widgetElement);
                dragPosition.left = parseFloat(computedStyle.left || '0');
                dragPosition.top = parseFloat(computedStyle.top || '0');
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', (e) => {
                if (dragActive) {
                    const dx = e.clientX - dragStart.x;
                    const dy = e.clientY - dragStart.y;
                    dragPosition.top = dragPosition.top + dy;
                    dragPosition.left = dragPosition.left + dx;
                    widgetElement.style.top = dragPosition.top + 'px';
                    widgetElement.style.left = dragPosition.left + 'px';
                    dragStart.x = e.clientX;
                    dragStart.y = e.clientY;
                }
            });

            document.addEventListener('mouseup', () => {
                if (dragActive) {
                    dragActive = false;
                    document.body.style.userSelect = '';
                }
            });
        }

        // --- WebSocket Setup ---

        const ws = new WebSocket(`ws://${location.hostname}:${location.port}/ws`);

        ws.onopen = function () {
            console.log('WebSocket connected');
        };
        ws.onerror = function (e) {
            console.error('WebSocket error:', e);
        };

        let roundZero = true;
        let awaitRefresh = false;
        ws.onmessage = function (evt) {
            const response = JSON.parse(evt.data);
            if (response.method === 'server-state-set' || response.method === 'server-state-init') {
                tweakIndex[response.result.key]?.apply(response.result.value);
                OutputUpdate(false, activeComponent, true);
            } else if (response.method === 'sketchpad-view') {
                if (AUTOREFRESH) {
                    if (awaitRefresh) { return; }
                    awaitRefresh = true;
                    setTimeout(() => awaitRefresh = false, 250);
                }
                try {
                    const newComponent = response.result;
                    if (newComponent && typeof newComponent === "object") {
                        if (roundZero) {
                            OutputUpdate(true, newComponent, true);
                        } else {
                            OutputUpdate(true, newComponent);
                        }
                    } else {
                        OutputUpdate(false);
                    }
                } catch (e) {
                    console.error("Unable to update component!");
                } finally {
                    roundZero = false;
                }
            }
        };


        // --- Tweak class modification ---
        class Tweak {
            constructor(key, fallback, applyFunction = () => { }, options = {}) {
                this.key = key;
                this.fallback = fallback;
                this.apply = applyFunction.bind(this);
                this.dom_element = this.element;
                this.options = options;
            }

            get element() {
                if (!this.dom_element) {
                    this.dom_element = document.getElementById(this.key);
                    if (this.dom_element) {
                        this.dom_element.addEventListener('change', () => { this.Update(); });
                    }
                }
                return this.dom_element;
            }

            Initialize() {
                if (this.element) {
                    const message = JSON.stringify({
                        jsonrpc: "2.0",
                        method: 'server-state-init',
                        id: Date.now(),
                        params: {
                            key: this.key,
                            value: this.fallback,
                        }
                    })
                    ws.send(message);
                    this.apply();
                }
            }

            Update() {
                if (ws.readyState === WebSocket.OPEN && this.element) {
                    const message = JSON.stringify({
                        jsonrpc: "2.0",
                        method: 'server-state-set',
                        id: Date.now(),
                        params: {
                            key: this.key,
                            value: this.element.type === 'checkbox'
                                ? this.element.checked
                                : this.element.value
                        }
                    })
                    ws.send(message);
                    this.apply();
                }
            }
        }

        const tweaks = [
            new Tweak('live-preview-option-color-picker', '#ffffff', function (value = this.element?.value) {
                if (this.element && value !== undefined) {
                    this.element.value = value;
                    document.getElementById("live-preview-body").style.setProperty("--live-preview-extension-background", value);
                }
            }),
            new Tweak('live-preview-option-live-cursor', false, function (value = this.element?.checked) {
                if (this.element && value !== undefined) {
                    const valBool = typeof value === "boolean" ? value : (value === 'true');
                    this.element.checked = valBool;
                    if (valBool) this.element.setAttribute("checked", "")
                    else this.element.removeAttribute("checked")
                    OutputUpdate();
                }
            }),
            new Tweak('live-preview-option-stop-sync', false, function (value = this.element?.checked) {
                if (this.element && value !== undefined) {
                    const valBool = typeof value === "boolean" ? value : (value === 'true');
                    this.element.checked = valBool;
                    outputState.syncDeactivate = valBool;
                    if (valBool) this.element.setAttribute("checked", "")
                    else this.element.removeAttribute("checked")
                    OutputUpdate();
                }
            }),

            new Tweak('live-preview-option-project-index', false, function (value = this.element?.checked) {
                if (this.element && value !== undefined) {
                    const valBool = typeof value === "boolean" ? value : (value === 'true');
                    this.element.checked = valBool;
                    outputState.useProjectCss = valBool;
                    if (valBool) this.element.setAttribute("checked", "")
                    else this.element.removeAttribute("checked")
                    OutputUpdate();
                }
            }),
            new Tweak('live-preview-option-container-resize', false, function (value = this.element?.checked) {
                if (this.element && value !== undefined) {
                    const valBool = typeof value === "boolean" ? value : (value === 'true');
                    this.element.checked = valBool;
                    outputState.activateResize = valBool;
                    if (valBool) this.element.setAttribute("checked", "")
                    else this.element.removeAttribute("checked")
                    OutputUpdate();
                }
            }),
            new Tweak('live-preview-option-preserve-scale', false, function (value = this.element?.checked) {
                if (this.element && value !== undefined) {
                    const valBool = typeof value === "boolean" ? value : (value === 'true');
                    this.element.checked = valBool;
                    outputState.preserveScale = valBool;
                    if (valBool) this.element.setAttribute("checked", "")
                    else this.element.removeAttribute("checked")
                    OutputUpdate();
                }
            }),
            new Tweak('live-preview-option-debug-mode', false, function (value = this.element?.checked) {
                if (this.element && value !== undefined) {
                    const valBool = typeof value === "boolean" ? value : (value === 'true');
                    this.element.checked = valBool;
                    outputState.activateDebug = valBool;
                    if (valBool) this.element.setAttribute("checked", "");
                    else this.element.removeAttribute("checked");
                    OutputUpdate();
                }
            }),
        ];

        function requstComponent() {
            if (!awaitRefresh) {
                ws.send(JSON.stringify({
                    jsonrpc: "2.0",
                    method: 'sketchpad-view',
                    id: Date.now(),
                    params: {}
                }));
            }
        }

        const tweakIndex = {};
        ws.onopen = () => {
            tweaks.forEach((tweak) => {
                tweakIndex[tweak.key] = tweak;
                tweak.Initialize();
            });
            requstComponent();
            if (AUTOREFRESH) {
                setInterval(() => requstComponent(), 1000);
            }
        };

    </script>

</body>

</html>