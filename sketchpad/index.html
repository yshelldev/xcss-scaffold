<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sketchpad</title>
    <style>@charset "UTF-8";:root{--live-preview-extension-background:white;--live-preview-extension-inactive:rgb(199, 69, 69);--live-preview-extension-active:rgb(0, 119, 166);--live-preview-extension-light:white;--live-preview-extension-dark:rgb(70, 70, 70);--live-preview-extension-delta:1.2rem;--live-preview-font-family:monospace;}.\~\$body_8r{background:var(--live-preview-extension-background);margin:0;padding:0;}.\~\$body_8r>main{display:flex;align-items:center;justify-content:center;min-width:100vw;min-height:100vh;}.\~\$op_8s [data-live-preview-output-container-preserve="true"]{box-shadow:0px 0px 32px -24px rgba(128, 128, 128, 0.5);}.\~\$op_8s [data-live-preview-output-container-resize="true"]{outline:solid 1px rgba(128, 128, 128, 0.5);overflow:auto;min-width:1rem;min-height:1rem;resize:both !important;}.\~\$op_8s [data-live-preview-output-container-debug="true"]{outline:rgba(255, 0, 0, 0.4) solid 1px !important;}.\~\$op_8s [data-live-preview-output-container-debug="true"] *{outline:rgba(255, 0, 0, 0.4) solid 1px !important;}.\~\$op_8s [data-live-preview-output-container-debug="true"] *:hover{outline:rgb(255, 0, 0) solid 1px !important;}.\~\$options_8v{gap:1em !important;display:flex !important;align-items:center !important;justify-content:center !important;}.\~\$options_8v>label{display:flex !important;align-items:center !important;justify-content:center !important;color:var(--live-preview-extension-dark) !important;transition:opacity 0.2s ease !important;opacity:.5 !important;border-radius:.5rem;padding:.4rem !important;gap:0rem !important;}.\~\$options_8v>label>*{margin:0 !important;width:var(--live-preview-extension-delta) !important;height:var(--live-preview-extension-delta) !important;}.\~\$options_8v>label:has(input[type=checkbox][checked]){--border-color:var(--live-preview-extension-active);}.\~\$options_8v>label:has(input[type=checkbox]){--border-color:var(--live-preview-extension-inactive);box-shadow:inset var(--border-color) 0px 0px 6px 1px !important;}.\~\$options_8v>label input{visibility:hidden !important;border:none !important;width:0 !important;padding:0 !important;background-color:.2rem solid var(--live-preview-extension-background) !important;}.\~\$options_8v>:hover{opacity:1 !important;}.\~\$symlink_8w{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;margin:0 !important;font-size:1rem !important;border-radius:.5em !important;font-family:var(--live-preview-font-family) !important;color:var(--live-preview-extension-dark) !important;box-shadow:rgba(0, 0, 0, 0.02) 0px 1px 3px 0px, rgba(27, 31, 35, 0.15) 0px 0px 0px 1px !important;padding:.4rem !important;user-select:none;}.\~frag\$\$widget{gap:.8rem !important;display:flex !important;box-sizing:border-box !important;flex-direction:column !important;justify-content:flex-start !important;color:var(--live-preview-extension-dark) !important;background-color:var(--live-preview-extension-light) !important;box-shadow:rgba(14, 30, 37, 0.12) 0px 2px 4px 0px, rgba(14, 30, 37, 0.32) 0px 2px 16px 0px !important;position:fixed !important;padding:.8rem !important;border-radius:1rem !important;opacity:.64 !important;transition:opacity 0.2s ease !important;}.\~frag\$\$widget:hover{opacity:.9 !important;}.\~frag\$\$widget *{outline:none !important;line-height:1.2em !important;box-sizing:inherit !important;}.\~frag\$\$widget *:hover{outline:none !important;}</style>
</head>

<body id="live-preview-body" class="~$body_8r" >

    <div id="live-preview-widget" style="top: 16px; left:16px; z-index: 1000000 !important;" class="~frag$$widget">
        
	<div class="~$options_8v" >

		<label id="live-preview-option-drag-handle" title="Move Widget">
			<svg>
				<use href="#_8g_8j_move"></use>
			</svg> </label>
		<label for="live-preview-option-color-picker" title="Background Color">
			<svg>
				<use href="#_8g_8q_bgcolor"></use>
			</svg>
			<input id="live-preview-option-color-picker" type="color">
		</label>

		<div style="width: var(--live-preview-extension-delta);"></div>

		<label for="live-preview-option-stop-sync" title="Deactivate Sync">
			<svg>
				<use href="#_8g_8m_unsync"></use>
			</svg>
			<input id="live-preview-option-stop-sync" type="checkbox">
		</label>

		<label for="live-preview-option-live-cursor" title="Live Cursor">
			<svg>
				<use href="#_8g_8r_cursor"></use>
			</svg>
			<input id="live-preview-option-live-cursor" type="checkbox">
		</label>

		<label for="live-preview-option-project-index" title="Project Theme">
			<svg>
				<use href="#_8g_8l_theme"></use>
			</svg>
			<input id="live-preview-option-project-index" type="checkbox">
		</label>

		<label for="live-preview-option-container-resize" title="Rescale Handle">
			<svg>
				<use href="#_8g_8k_rescale"></use>
			</svg>
			<input id="live-preview-option-container-resize" type="checkbox">
		</label>

		<label for="live-preview-option-preserve-scale" title="Preserve Scale">
			<svg>
				<use href="#_8g_8h_preserve"></use>
			</svg>
			<input id="live-preview-option-preserve-scale" type="checkbox">
		</label>

		<label for="live-preview-option-debug-mode" title="Debug Mode">
			<svg>
				<use href="#_8g_8s_debug"></use>
			</svg>
			<input id="live-preview-option-debug-mode" type="checkbox">
		</label>

	</div>
	<div id="live-preview-symlink" class="~$symlink_8w" >N/A</div>

    </div>

    <div id="live-preview-output-stitch" style="display: none;"></div>

    <style id="live-preview-root-css"></style>
    <style id="live-preview-comp-css"></style>
    <main id="live-preview-main" class="~$op_8s" >

        <div id="live-preview-output-container" data-live-preview-output-container-resize="true"
            data-live-preview-output-container-preserve="true" data-live-preview-output-container-debug="true">
            <div>{Content}</div>
        </div>
    </main>

    <div style="display: none;">
        
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
        <symbol id="_8g_8s_debug" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path d="m8 2 1.88 1.88" />
            <path d="M14.12 3.88 16 2" />
            <path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1" />
            <path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6" />
            <path d="M12 20v-9" />
            <path d="M6.53 9C4.6 8.8 3 7.1 3 5" />
            <path d="M6 13H2" />
            <path d="M3 21c0-2.1 1.7-3.9 3.8-4" />
            <path d="M20.97 5c0 2.1-1.6 3.8-3.5 4" />
            <path d="M22 13h-4" />
            <path d="M17.2 17c2.1.1 3.8 1.9 3.8 4" />
        </symbol>
    </svg>

    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
        <symbol id="_8g_8h_preserve" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M19.5 7a24 24 0 0 1 0 10" />
            <path d="M4.5 7a24 24 0 0 0 0 10" />
            <path d="M7 19.5a24 24 0 0 0 10 0" />
            <path d="M7 4.5a24 24 0 0 1 10 0" />
            <rect x="17" y="17" width="5" height="5" rx="1" />
            <rect x="17" y="2" width="5" height="5" rx="1" />
            <rect x="2" y="17" width="5" height="5" rx="1" />
            <rect x="2" y="2" width="5" height="5" rx="1" />
        </symbol>
    </svg>

    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
        <symbol id="_8g_8q_bgcolor" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="m19 11-8-8-8.6 8.6a2 2 0 0 0 0 2.8l5.2 5.2c.8.8 2 .8 2.8 0L19 11Z" />
            <path d="m5 2 5 5" />
            <path d="M2 13h15" />
            <path d="M22 20a2 2 0 1 1-4 0c0-1.6 1.7-2.4 2-4 .3 1.6 2 2.4 2 4Z" />
        </symbol>
    </svg>

    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
        <symbol id="_8g_8l_theme" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="m14.622 17.897-10.68-2.913" />
            <path
                d="M18.376 2.622a1 1 0 1 1 3.002 3.002L17.36 9.643a.5.5 0 0 0 0 .707l.944.944a2.41 2.41 0 0 1 0 3.408l-.944.944a.5.5 0 0 1-.707 0L8.354 7.348a.5.5 0 0 1 0-.707l.944-.944a2.41 2.41 0 0 1 3.408 0l.944.944a.5.5 0 0 0 .707 0z" />
            <path
                d="M9 8c-1.804 2.71-3.97 3.46-6.583 3.948a.507.507 0 0 0-.302.819l7.32 8.883a1 1 0 0 0 1.185.204C12.735 20.405 16 16.792 16 15" />
        </symbol>
    </svg>

    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
        <symbol id="_8g_8j_move" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path d="M12 2v20" />
            <path d="m15 19-3 3-3-3" />
            <path d="m19 9 3 3-3 3" />
            <path d="M2 12h20" />
            <path d="m5 9-3 3 3 3" />
            <path d="m9 5 3-3 3 3" />
        </symbol>
    </svg>

    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
        <symbol id="_8g_8m_unsync" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 8L18.74 5.74A9.75 9.75 0 0 0 12 3C11 3 10.03 3.16 9.13 3.47" />
            <path d="M8 16H3v5" />
            <path d="M3 12C3 9.51 4 7.26 5.64 5.64" />
            <path d="m3 16 2.26 2.26A9.75 9.75 0 0 0 12 21c2.49 0 4.74-1 6.36-2.64" />
            <path d="M21 12c0 1-.16 1.97-.47 2.87" />
            <path d="M21 3v5h-5" />
            <path d="M22 22 2 2" />
        </symbol>
    </svg>
   
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
        <symbol id="_8g_8r_cursor" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path d="M14 4.1 12 6" />
            <path d="m5.1 8-2.9-.8" />
            <path d="m6 12-1.9 2" />
            <path d="M7.2 2.2 8 5.1" />
            <path
                d="M9.037 9.69a.498.498 0 0 1 .653-.653l11 4.5a.5.5 0 0 1-.074.949l-4.349 1.041a1 1 0 0 0-.74.739l-1.04 4.35a.5.5 0 0 1-.95.074z" />
        </symbol>
    </svg>

    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
        <symbol id="_8g_8k_rescale" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
            <path d="M14 15H9v-5" />
            <path d="M16 3h5v5" />
            <path d="M21 3 9 15" />
        </symbol>
    </svg>

    </div>

    
    <script>

        const AUTOREFRESH = false;

        // --- Initial Load ---

        const RootBody = document.getElementById('live-preview-body');
        const RootMain = document.getElementById('live-preview-main');
        window.addEventListener('load', () => {
            setTimeout(() => {
                RootBody.parentElement.removeAttribute("style");
            }, 100);
        });

        // --- Deploy Output Fragment ----

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        const StitchElement = document.getElementById('live-preview-output-stitch');
        const OutputElement = document.getElementById('live-preview-output-container');
        const RootCssElement = document.getElementById('live-preview-root-css');
        const CompCssElement = document.getElementById('live-preview-comp-css');
        const SymlinkElement = document.getElementById('live-preview-symlink');

        const activeComponent = {
            preview: "",
            element: "",
            depends: "",
            symlink: "",
            rootcss: "",
            compcss: "",
            configs: {},
            attributes: {},
            timestamp: ""
        };

        const outputState = {
            useProjectCss: false,
            activateResize: false,
            preserveScale: false,
            activateDebug: false,
            syncDeactivate: false,
        };


        let OutputStyle = '';
        function OutputUpdate(
            updateComponent = false,
            newComponent = activeComponent,
            syncForce = !outputState.syncDeactivate
        ) {

            if (OutputElement.hasAttribute('style')) { OutputStyle = OutputElement.getAttribute('style') ?? OutputStyle; }

            if (outputState.preserveScale) {
                OutputElement.setAttribute('style', OutputStyle);
            } else {
                if (outputState.activateResize && !OutputElement.hasAttribute('style')) { OutputElement.setAttribute('style', OutputStyle); }
                else if (!outputState.activateResize && OutputElement.hasAttribute('style')) { OutputElement.removeAttribute('style'); }
            }
            OutputElement.setAttribute("data-live-preview-output-container-debug", String(outputState.activateDebug))
            OutputElement.setAttribute("data-live-preview-output-container-resize", String(outputState.activateResize))
            OutputElement.setAttribute("data-live-preview-output-container-preserve", String(outputState.preserveScale))
            OutputElement.setAttribute("data-live-preview-output-container-preserve", String(outputState.preserveScale))


            if (updateComponent && syncForce) {
                CompCssElement.innerText = newComponent.compcss;
                RootCssElement.innerText = outputState.useProjectCss ? newComponent.rootcss : "";

                const stitch = (typeof newComponent.depends === "string") ? newComponent.depends : '';
                const structure = (typeof newComponent.preview === "string" && newComponent.preview.length) ? newComponent.preview : "[Placeholder]";
                const selector = (typeof newComponent.symlink === "string" && newComponent.symlink.length) ? newComponent.symlink : '[N/A]';

                StitchElement.innerHTML = stitch;
                OutputElement.innerHTML = structure;
                OutputElement.className = "_";
                SymlinkElement.innerHTML = selector;
                const attributes = newComponent.attributes || {};

                RootMain.setAttribute(
                    "style",
                    typeof attributes["style"] === "string"
                        ? attributes["style"].replace(/^['"]|['"]$/g, "")
                        : ""
                );

                const attrTrace = {};
                const constAttrs = [
                    "id", "style",
                    "data-live-preview-output-container-debug",
                    "data-live-preview-output-container-resize",
                    "data-live-preview-output-container-preserve"
                ]
                OutputElement.getAttributeNames().forEach(a => {
                    if (!constAttrs.includes(a) && a !== "class") { attrTrace[a] = true; }
                });

                Object.keys(attributes).forEach(a => {
                    if (!constAttrs.includes(a)) { attrTrace[a] = false; }
                });

                Object.entries(attrTrace).forEach(([attr, delflag]) => {
                    if (delflag) {
                        OutputElement.removeAttribute(attr)
                    } else if (attr === "class") {
                        const fval = attributes[attr].replace(/^['"]|['"]$/g, "")
                        OutputElement.classList.add(...fval.split(" "))
                    } else {
                        const fval = attributes[attr].replace(/^['"]|['"]$/g, "")
                        OutputElement.setAttribute(attr, fval)
                    }
                })
            }
            Object.assign(activeComponent, newComponent);
        }

        // --- Drag handle Logic ---

        let dragActive = false;
        const dragStart = { x: 0, y: 0 };
        const dragPosition = { top: 0, left: 0 };
        const widgetElement = document.getElementById('live-preview-widget');
        const dragElement = document.getElementById('live-preview-option-drag-handle');

        if (dragElement && widgetElement) {
            dragElement.addEventListener('mousedown', (e) => {
                dragActive = true;
                dragStart.x = e.clientX;
                dragStart.y = e.clientY;
                const computedStyle = window.getComputedStyle(widgetElement);
                dragPosition.left = parseFloat(computedStyle.left || '0');
                dragPosition.top = parseFloat(computedStyle.top || '0');
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', (e) => {
                if (dragActive) {
                    const dx = e.clientX - dragStart.x;
                    const dy = e.clientY - dragStart.y;
                    dragPosition.top = dragPosition.top + dy;
                    dragPosition.left = dragPosition.left + dx;
                    widgetElement.style.top = dragPosition.top + 'px';
                    widgetElement.style.left = dragPosition.left + 'px';
                    dragStart.x = e.clientX;
                    dragStart.y = e.clientY;
                }
            });

            document.addEventListener('mouseup', () => {
                if (dragActive) {
                    dragActive = false;
                    document.body.style.userSelect = '';
                }
            });
        }

        // --- WebSocket Setup ---

        const ws = new WebSocket(`ws://${location.hostname}:${location.port}/ws`);

        ws.onopen = function () {
            console.log('WebSocket connected');
        };
        ws.onerror = function (e) {
            console.error('WebSocket error:', e);
        };

        let roundZero = true;
        let awaitRefresh = false;
        ws.onmessage = function (evt) {
            const response = JSON.parse(evt.data);
            if (response.method === 'server-state-set' || response.method === 'server-state-init') {
                tweakIndex[response.result.key]?.apply(response.result.value);
                OutputUpdate(false, activeComponent, true);
            } else if (response.method === 'sketchpad-view') {
                if (AUTOREFRESH) {
                    if (awaitRefresh) { return; }
                    awaitRefresh = true;
                    setTimeout(() => awaitRefresh = false, 250);
                }
                try {
                    const newComponent = response.result;
                    if (newComponent && typeof newComponent === "object") {
                        if (roundZero) {
                            OutputUpdate(true, newComponent, true);
                        } else {
                            OutputUpdate(true, newComponent);
                        }
                    } else {
                        OutputUpdate(false);
                    }
                } catch (e) {
                    console.error("Unable to update component!");
                } finally {
                    roundZero = false;
                }
            }
        };


        // --- Tweak class modification ---
        class Tweak {
            constructor(key, fallback, applyFunction = () => { }, options = {}) {
                this.key = key;
                this.fallback = fallback;
                this.apply = applyFunction.bind(this);
                this.dom_element = this.element;
                this.options = options;
            }

            get element() {
                if (!this.dom_element) {
                    this.dom_element = document.getElementById(this.key);
                    if (this.dom_element) {
                        this.dom_element.addEventListener('change', () => { this.Update(); });
                    }
                }
                return this.dom_element;
            }

            Initialize() {
                if (this.element) {
                    const message = JSON.stringify({
                        jsonrpc: "2.0",
                        method: 'server-state-init',
                        id: Date.now(),
                        params: {
                            key: this.key,
                            value: this.fallback,
                        }
                    })
                    ws.send(message);
                    this.apply();
                }
            }

            Update() {
                if (ws.readyState === WebSocket.OPEN && this.element) {
                    const message = JSON.stringify({
                        jsonrpc: "2.0",
                        method: 'server-state-set',
                        id: Date.now(),
                        params: {
                            key: this.key,
                            value: this.element.type === 'checkbox'
                                ? this.element.checked
                                : this.element.value
                        }
                    })
                    ws.send(message);
                    this.apply();
                }
            }
        }

        const tweaks = [
            new Tweak('live-preview-option-color-picker', '#ffffff', function (value = this.element?.value) {
                if (this.element && value !== undefined) {
                    this.element.value = value;
                    document.getElementById("live-preview-body").style.setProperty("--live-preview-extension-background", value);
                }
            }),
            new Tweak('live-preview-option-live-cursor', false, function (value = this.element?.checked) {
                if (this.element && value !== undefined) {
                    const valBool = typeof value === "boolean" ? value : (value === 'true');
                    this.element.checked = valBool;
                    if (valBool) this.element.setAttribute("checked", "")
                    else this.element.removeAttribute("checked")
                    OutputUpdate();
                }
            }),
            new Tweak('live-preview-option-stop-sync', false, function (value = this.element?.checked) {
                if (this.element && value !== undefined) {
                    const valBool = typeof value === "boolean" ? value : (value === 'true');
                    this.element.checked = valBool;
                    outputState.syncDeactivate = valBool;
                    if (valBool) this.element.setAttribute("checked", "")
                    else this.element.removeAttribute("checked")
                    OutputUpdate();
                }
            }),

            new Tweak('live-preview-option-project-index', false, function (value = this.element?.checked) {
                if (this.element && value !== undefined) {
                    const valBool = typeof value === "boolean" ? value : (value === 'true');
                    this.element.checked = valBool;
                    outputState.useProjectCss = valBool;
                    if (valBool) this.element.setAttribute("checked", "")
                    else this.element.removeAttribute("checked")
                    OutputUpdate();
                }
            }),
            new Tweak('live-preview-option-container-resize', false, function (value = this.element?.checked) {
                if (this.element && value !== undefined) {
                    const valBool = typeof value === "boolean" ? value : (value === 'true');
                    this.element.checked = valBool;
                    outputState.activateResize = valBool;
                    if (valBool) this.element.setAttribute("checked", "")
                    else this.element.removeAttribute("checked")
                    OutputUpdate();
                }
            }),
            new Tweak('live-preview-option-preserve-scale', false, function (value = this.element?.checked) {
                if (this.element && value !== undefined) {
                    const valBool = typeof value === "boolean" ? value : (value === 'true');
                    this.element.checked = valBool;
                    outputState.preserveScale = valBool;
                    if (valBool) this.element.setAttribute("checked", "")
                    else this.element.removeAttribute("checked")
                    OutputUpdate();
                }
            }),
            new Tweak('live-preview-option-debug-mode', false, function (value = this.element?.checked) {
                if (this.element && value !== undefined) {
                    const valBool = typeof value === "boolean" ? value : (value === 'true');
                    this.element.checked = valBool;
                    outputState.activateDebug = valBool;
                    if (valBool) this.element.setAttribute("checked", "");
                    else this.element.removeAttribute("checked");
                    OutputUpdate();
                }
            }),
        ];

        function requstComponent() {
            if (!awaitRefresh) {
                ws.send(JSON.stringify({
                    jsonrpc: "2.0",
                    method: 'sketchpad-view',
                    id: Date.now(),
                    params: {}
                }));
            }
        }

        const tweakIndex = {};
        ws.onopen = () => {
            tweaks.forEach((tweak) => {
                tweakIndex[tweak.key] = tweak;
                tweak.Initialize();
            });
            requstComponent();
            if (AUTOREFRESH) {
                setInterval(() => requstComponent(), 1000);
            }
        };

    </script>

</body>

</html>